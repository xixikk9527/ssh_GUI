<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web SSH & SFTP Manager</title>
    <!-- xterm.js (Local) -->
    <link rel="stylesheet" href="/static/xterm.css" />
    <script src="/static/xterm.js"></script>
    <script src="/static/addon-fit.js"></script>
    
    <!-- Font Awesome (CDN) -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #1e1e1e; color: #ccc; }
        
        /* Login Modal */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: #252526; padding: 30px; border-radius: 8px; width: 300px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .login-box h2 { margin-top: 0; color: #fff; text-align: center; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 12px; }
        .input-group input { 
            width: 100%; padding: 8px; background: #3c3c3c; border: 1px solid #3c3c3c; 
            color: white; border-radius: 4px; box-sizing: border-box;
        }
        button.btn-primary {
            width: 100%; padding: 10px; background: #007acc; border: none; 
            color: white; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        button.btn-primary:hover { background: #0062a3; }

        /* Main Layout */
        #app { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        #app.active { opacity: 1; pointer-events: all; }

        /* Sidebar */
        #sidebar {
            width: 250px; background: #252526; border-right: 1px solid #000;
            display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 10px; font-weight: bold; background: #333333; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 5px; }
        .file-item {
            padding: 4px 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            user-select: none; font-size: 13px; display: flex; align-items: center; gap: 6px;
        }
        .file-item:hover { background: #2a2d2e; }
        .file-item.active { background: #37373d; }
        .file-item i { width: 16px; text-align: center; }
        .fa-folder { color: #dcb67a; }
        .fa-file { color: #519aba; }

        /* Main Area */
        #main-area { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; }
        
        /* Tabs */
        .tabs-header {
            height: 35px; background: #2d2d2d; display: flex; align-items: center;
            border-bottom: 1px solid #000;
        }
        .tab {
            padding: 0 15px; height: 100%; display: flex; align-items: center; cursor: pointer;
            background: #2d2d2d; color: #969696; font-size: 13px; border-right: 1px solid #1e1e1e;
        }
        .tab.active { background: #1e1e1e; color: #fff; }
        .tab:hover { background: #1e1e1e; }
        
        .tab-content { flex: 1; position: relative; overflow: hidden; display: none; }
        .tab-content.active { display: block; }

        /* Terminal */
        #terminal-container { width: 100%; height: 100%; padding: 5px; box-sizing: border-box; }

        /* Editor */
        #editor-container { width: 100%; height: 100%; }
        
        /* Toolbar */
        .toolbar { padding: 5px; background: #333; display: flex; gap: 10px; }
        .btn-sm { padding: 2px 8px; font-size: 12px; cursor: pointer; background: #444; color: white; border: none; border-radius: 2px; }
        .btn-sm:hover { background: #555; }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <h2><i class="fa-solid fa-terminal"></i> XXShell</h2>
            <div class="input-group">
                <label>Hostname</label>
                <input type="text" id="host" value="192.168.1.100">
            </div>
            <div class="input-group">
                <label>Port</label>
                <input type="number" id="port" value="22">
            </div>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="user" value="root">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="pass">
            </div>
            <button class="btn-primary" onclick="connect()">Connect</button>
            <p id="error-msg" style="color: red; font-size: 12px; margin-top: 10px; text-align: center;"></p>
        </div>
    </div>

    <!-- App UI -->
    <div id="app">
        <div id="sidebar">
            <div class="sidebar-header">
                <span>EXPLORER</span>
                <div style="font-size: 12px;">
                    <i class="fa-solid fa-sync" style="cursor: pointer;" title="Refresh" onclick="refreshFileTree()"></i>
                    <i class="fa-solid fa-upload" style="cursor: pointer; margin-left: 5px;" title="Upload" onclick="document.getElementById('upload-input').click()"></i>
                    <input type="file" id="upload-input" style="display: none;" onchange="handleUpload(this)">
                </div>
            </div>
            <div class="sidebar-content" id="file-tree">
                <!-- File Tree Generated JS -->
            </div>
        </div>
        
        <div id="main-area">
            <div class="tabs-header">
                <div class="tab active" onclick="switchTab('terminal')">Terminal</div>
                <div class="tab" onclick="switchTab('editor')">Editor</div>
            </div>
            
            <div id="terminal-content" class="tab-content active">
                <div id="terminal-container"></div>
            </div>
            
            <div id="editor-content" class="tab-content">
                <div class="toolbar">
                    <button class="btn-sm" onclick="saveFile()"><i class="fa-solid fa-save"></i> Save</button>
                    <button class="btn-sm" onclick="downloadCurrentFile()"><i class="fa-solid fa-download"></i> Download</button>
                    <span id="current-file-path" style="margin-left: 10px; font-size: 12px; align-self: center;"></span>
                </div>
                <div id="editor-container"></div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <script>
        let session_id = null;
        let term, socket, fitAddon;
        let editor;
        let currentPath = ".";
        let currentEditingFile = null;

        // Init Monaco
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: "// Select a file to edit...",
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true
            });
            
            // Add Save Command (Ctrl+S)
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
                saveFile();
            });
        });

        async function connect() {
            const host = document.getElementById('host').value;
            const port = document.getElementById('port').value;
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            const btn = document.querySelector('button.btn-primary');
            const errorMsg = document.getElementById('error-msg');

            btn.disabled = true;
            btn.innerText = "Connecting...";
            errorMsg.innerText = "";

            try {
                const res = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ hostname: host, port: parseInt(port), username: user, password: pass })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    session_id = data.session_id;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app').classList.add('active');
                    
                    initTerminal();
                    refreshFileTree();
                } else {
                    errorMsg.innerText = data.detail || "Connection failed";
                }
            } catch (e) {
                errorMsg.innerText = "Network Error: " + e.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "Connect";
            }
        }

        function initTerminal() {
            if (typeof Terminal === 'undefined') {
                alert("xterm.js library not loaded. Please check your network connection.");
                return;
            }

            term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: { background: '#1e1e1e' }
            });
            
            // Handle FitAddon loading variations (Global vs Namespace)
            let FitAddonClass;
            if (typeof FitAddon === 'object' && FitAddon.FitAddon) {
                FitAddonClass = FitAddon.FitAddon;
            } else if (typeof FitAddon === 'function') {
                FitAddonClass = FitAddon;
            } else {
                console.error("FitAddon library not loaded correctly.");
                alert("Terminal Addon failed to load.");
                return;
            }

            fitAddon = new FitAddonClass();
            term.loadAddon(fitAddon);
            
            const container = document.getElementById('terminal-container');
            term.open(container);
            fitAddon.fit();
            
            // Add ResizeObserver to ensure fit works when container changes size (e.g. switching tabs)
            const resizeObserver = new ResizeObserver(entries => {
                fitAddon.fit();
                sendResize();
            });
            resizeObserver.observe(container);

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/ws/ssh/${session_id}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                term.write('\r\n\x1b[32mConnected to SSH Session...\x1b[0m\r\n');
                sendResize();
            };
            socket.onmessage = (e) => term.write(e.data);
            term.onData(data => socket.send(data));
            
            window.addEventListener('resize', () => {
                fitAddon.fit();
                sendResize();
            });
        }

        function sendResize() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'terminal') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('terminal-content').classList.add('active');
                if (fitAddon) fitAddon.fit();
                setTimeout(() => term.focus(), 100);
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('editor-content').classList.add('active');
            }
        }

        async function refreshFileTree(path = '.') {
            const container = document.getElementById('file-tree');
            if (path === '.') container.innerHTML = '<div style="padding:10px">Loading...</div>';
            
            try {
                const res = await fetch(`/api/files/list?session_id=${session_id}&path=${encodeURIComponent(path)}`);
                const data = await res.json();
                
                if (path === '.') {
                    currentPath = data.current_path;
                    container.innerHTML = '';
                    renderFileList(container, data.files, currentPath);
                } else {
                    // For subdirectories - simplified for prototype (just navigate into)
                    // In a full tree, we would append. Here we act like a simple file browser
                    currentPath = data.current_path;
                    container.innerHTML = `<div class="file-item" onclick="refreshFileTree('..')"><i class="fa-solid fa-arrow-up"></i> ..</div>`;
                    renderFileList(container, data.files, currentPath);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderFileList(container, files, basePath) {
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                const icon = file.is_dir ? 'fa-folder' : 'fa-file';
                div.innerHTML = `<i class="fa-solid ${icon}"></i> ${file.name}`;
                
                const fullPath = (basePath === '/' ? '' : basePath) + '/' + file.name;
                
                div.onclick = () => {
                    if (file.is_dir) {
                        refreshFileTree(fullPath);
                    } else {
                        openFile(fullPath);
                    }
                };
                container.appendChild(div);
            });
        }

        async function openFile(path) {
            try {
                const res = await fetch(`/api/files/content?session_id=${session_id}&path=${encodeURIComponent(path)}`);
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail);
                    return;
                }
                const data = await res.json();
                
                currentEditingFile = path;
                document.getElementById('current-file-path').innerText = path;
                
                // Detect language simplisticly
                let lang = 'plaintext';
                if (path.endsWith('.py')) lang = 'python';
                if (path.endsWith('.js')) lang = 'javascript';
                if (path.endsWith('.html')) lang = 'html';
                if (path.endsWith('.json')) lang = 'json';
                
                monaco.editor.setModelLanguage(editor.getModel(), lang);
                editor.setValue(data.content);
                
                switchTab('editor');
            } catch (e) {
                alert("Failed to open file");
            }
        }

        async function saveFile() {
            if (!currentEditingFile) return;
            
            try {
                const content = editor.getValue();
                const res = await fetch('/api/files/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_id, path: currentEditingFile, content })
                });
                
                if (res.ok) {
                    alert("File saved successfully!");
                } else {
                    alert("Failed to save file");
                }
            } catch (e) {
                alert("Error saving file");
            }
        }

        async function handleUpload(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            
            const formData = new FormData();
            formData.append('session_id', session_id);
            formData.append('path', currentPath);
            formData.append('file', file);
            
            try {
                const res = await fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    alert("Upload successful");
                    refreshFileTree(currentPath);
                } else {
                    alert("Upload failed");
                }
            } catch (e) {
                alert("Error uploading");
            }
            input.value = ''; // Reset
        }

        function downloadCurrentFile() {
            if (!currentEditingFile) {
                alert("No file currently open");
                return;
            }
            const url = `/api/files/download?session_id=${session_id}&path=${encodeURIComponent(currentEditingFile)}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
