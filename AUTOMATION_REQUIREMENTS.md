# 自动化任务录制/播放功能 - 需求文档

## 项目概述
实现一个无需管理员权限的自动化任务录制和播放系统，支持鼠标和键盘操作的完整记录和重放。

---

## 核心需求

### 1. 录制功能 (Recording)

#### 1.1 支持的操作类型
- **鼠标操作**
  - 左键点击 (单击)
  - 右键点击 (右键菜单)
  - 中键点击
  - 双击 (double-click)
  - 拖拽 (drag with coordinates)
  - 滚轮 (scroll up/down)

- **键盘操作**
  - 所有字符键 (a-z, 0-9, 符号等)
  - 功能键 (F1-F12, Enter, Tab, Backspace, Delete, Escape等)
  - 修饰键 (Shift, Ctrl, Alt, Win)
  - 组合键 (Ctrl+S, Win+D, Alt+Tab等)
  - 所有按键必须记录具体的字符或键名

#### 1.2 录制流程
1. 用户点击"开始录制"按钮
2. 浏览器显示"正在录制中"提示框（右下角，红色背景）
3. 系统开始全局监听鼠标和键盘事件
4. 用户在桌面或任何应用中执行操作
5. 所有操作被记录到内存中，包含：
   - 操作类型 (mouse_click, mouse_move, key_press等)
   - 时间戳 (相对于录制开始的时间)
   - 坐标 (鼠标操作)
   - 按键名称 (键盘操作)
   - 按键状态 (按下/释放)

#### 1.3 停止录制
- **ESC键停止**: 用户在任何地方按下ESC键，立即停止录制
- **立即返回浏览器**: 停止后自动返回浏览器窗口
- **自动保存**: 录制的任务自动保存到数据库
- **UI更新**: 浏览器立即显示新保存的任务

#### 1.4 录制提示框
- 位置: 屏幕右下角
- 样式: 红色背景 (#d32f2f)，白色文字
- 内容: "● 录制中 (ESC停止)"
- 显示时机: 录制开始时显示，停止时隐藏
- 透明度: 90% (不完全遮挡)

---

### 2. 播放功能 (Playback)

#### 2.1 播放流程
1. 用户选择已保存的任务，点击"执行"按钮
2. 系统确认用户是否继续 (警告: 不要操作鼠标和键盘)
3. 浏览器最小化到桌面 (或切换到后台)
4. 屏幕右下角显示"正在执行中"提示框 (绿色背景)
5. 系统按照录制的时间间隔重放所有操作
6. 播放完成后，返回浏览器窗口

#### 2.2 播放执行
- **时间精度**: 保持录制时的相对时间间隔
- **速度控制**: 支持调整播放速度 (默认1.0x)
- **坐标准确**: 鼠标操作必须在正确的坐标执行
- **按键准确**: 所有按键必须完全重现，包括组合键
- **修饰键释放**: 播放完成后，自动释放所有修饰键 (Shift, Ctrl, Alt, Win)

#### 2.3 执行提示框
- 位置: 屏幕右下角
- 样式: 绿色背景 (#4CAF50)，白色文字
- 内容: "▶ 执行中..."
- 显示时机: 播放开始时显示，完成时隐藏
- 透明度: 90%

---

### 3. 任务管理

#### 3.1 任务存储
- 格式: JSON文件
- 位置: `data/automation_tasks/`
- 文件名: `{task_id}.json`
- 内容结构:
  ```json
  {
    "id": "abc12345",
    "name": "任务_20250110_143022",
    "created_at": "2025-01-10T14:30:22.123456",
    "duration": 45.23,
    "events": [
      {
        "type": "mouse_click",
        "time": 0.5,
        "x": 100,
        "y": 200,
        "button": "left",
        "pressed": true
      },
      ...
    ]
  }
  ```

#### 3.2 任务列表
- 显示所有已保存的任务
- 每个任务卡片显示:
  - 任务名称
  - 录制时长
  - 操作数量
  - 创建时间
- 操作按钮:
  - 执行 (绿色)
  - 重命名 (编辑)
  - 删除 (红色)

#### 3.3 任务操作
- **执行**: 播放任务中的所有操作
- **重命名**: 修改任务名称
- **删除**: 永久删除任务

---

## 技术实现要求

### 4.1 无需管理员权限
- 使用 `keyboard` 库进行全局键盘监听 (无需管理员)
- 使用 `pynput` 库进行鼠标监听 (无需管理员)
- 使用 `pyautogui` 库进行鼠标和键盘操作 (无需管理员)

### 4.2 DPI感知
- 设置进程DPI感知，修复高分辨率屏幕上的鼠标坐标偏移
- Windows 10+: `ctypes.windll.shcore.SetProcessDpiAwareness(2)`
- Windows 7/8: `ctypes.windll.user32.SetProcessDPIAware()`

### 4.3 事件处理
- **鼠标事件**: 记录按下/释放状态，支持拖拽
- **键盘事件**: 记录按下/释放状态，支持组合键
- **时间戳**: 相对于录制开始的时间 (秒)
- **控制字符过滤**: 过滤空字符串和无效按键

### 4.4 ESC键处理
- 全局监听ESC键，不受焦点限制
- 按下ESC时立即停止录制
- 无延迟响应 (使用事件而非轮询)

### 4.5 窗口管理
- 提示框使用Tkinter创建，设置为最顶层窗口
- 提示框不可交互，仅用于显示状态
- 播放时浏览器自动最小化或切换到后台
- 播放完成后返回浏览器

---

## 已知问题和解决方案

### 问题1: ESC键延迟响应
**原因**: 使用轮询检查ESC状态
**解决**: 使用 `threading.Event` 替代轮询

### 问题2: 鼠标坐标偏移
**原因**: 未设置DPI感知
**解决**: 在程序启动时设置DPI感知

### 问题3: 控制字符显示为空
**原因**: 某些按键的名称为空字符串
**解决**: 过滤空字符串，只记录有效的按键名称

### 问题4: 组合键只记录一个键
**原因**: 修饰键和普通键分别触发事件
**解决**: 分别记录每个按键事件，播放时按顺序执行

### 问题5: 播放后键盘混乱
**原因**: 修饰键未正确释放
**解决**: 播放完成后强制释放所有修饰键

### 问题6: 双击和右键未记录
**原因**: 事件处理不完整
**解决**: 完整处理所有鼠标按钮和事件类型

---

## API端点

### 录制相关
- `POST /api/automation/start-recording` - 开始录制
- `POST /api/automation/stop-recording` - 停止录制
- `GET /api/automation/recording-status` - 获取录制状态

### 任务管理
- `GET /api/automation/tasks` - 获取任务列表
- `GET /api/automation/task/{task_id}` - 获取任务详情
- `POST /api/automation/task/{task_id}/execute` - 执行任务
- `PUT /api/automation/task/{task_id}/rename` - 重命名任务
- `DELETE /api/automation/task/{task_id}` - 删除任务

---

## 文件结构

```
app/
├── routers/
│   └── automation.py          # API端点
├── utils/
│   ├── recorder.py            # 录制逻辑
│   └── player.py              # 播放逻辑
templates/
├── partials/
│   └── automation.html        # UI模板
static/
├── js/
│   └── automation.js          # 前端逻辑
└── css/
    └── modules/
        └── automation.css     # 样式
data/
└── automation_tasks/          # 任务存储目录
```

---

## 测试场景

### 场景1: 基础录制和播放
1. 点击"开始录制"
2. 在桌面上点击、输入文字、按快捷键
3. 按ESC停止录制
4. 验证任务已保存
5. 点击"执行"播放任务
6. 验证所有操作被正确重现

### 场景2: 组合键
1. 录制 Win+D (最小化)
2. 录制 Ctrl+S (保存)
3. 录制 Alt+Tab (切换窗口)
4. 验证组合键被正确记录和执行

### 场景3: 鼠标操作
1. 录制单击、双击、右键
2. 录制拖拽操作
3. 录制滚轮操作
4. 验证所有操作被正确重现

### 场景4: 任务管理
1. 创建多个任务
2. 重命名任务
3. 删除任务
4. 验证UI正确更新

---

## 性能要求

- 录制延迟: < 50ms
- 播放精度: ±100ms (相对时间)
- 内存占用: < 10MB (1000个事件)
- 响应时间: < 1s (UI更新)

---

## 安全考虑

- 不需要管理员权限
- 不修改系统设置
- 不访问敏感文件
- 任务数据本地存储
- 支持任务删除

